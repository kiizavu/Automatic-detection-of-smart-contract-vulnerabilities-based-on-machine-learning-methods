import csv
import os
import re

checklist = 'checklist_0.csv'
contract_scan = 'pentest_smartcontract/scan/'
with open(checklist, 'r') as cl:
    csv_reader = csv.DictReader(cl)
    csv_reader = list(csv_reader)
    # for row in csv_reader:
    #     print(row)

def get_vuln(row, filename):

    cc = {
        'Integer Overflow': 'arithmetic',
        'Integer Underflow': 'arithmetic',
        'Reentrancy': 'reentrancy',
        'Time Manipulation': 'time_manipulation',
        'Transaction Ordering Dependence': 'TOD'
    }    

    with open(os.path.join(contract_scan, filename), 'r') as f:
        content = [s.strip() for s in f.readlines()]
        
        dic = {}
        dic['address'] = filename[:-4]
        for _ in content:
            if 'Vulnerability:' in _:
                vuln = re.search('Vulnerability: (.*). Maybe in function:', _)
                line = re.search('Line number: (.*).', _)
                vuln = vuln.group(1)
                if vuln == 'Unchecked Low Level Call':
                    continue
                vuln = cc[vuln]
                line = line.group(1)

                if vuln not in dic.keys():
                    dic[vuln] = ''
                    dic[vuln] += line
                elif line not in dic[vuln]:
                    dic[vuln] += ', ' + line

        for __ in dic.keys():
            row[__] = dic[__]
        return row

contracts = os.listdir(contract_scan)
for contract in contracts:
    for row in csv_reader:
        if row['address'] == contract[:-4]:
            row = get_vuln(row, contract)
        

csv_columns = ['address', 'arithmetic', 'reentrancy', 'time_manipulation', 'TOD', 'tx_origin']
with open('pentest_smartcontract/checklist.csv', 'w') as f:
    writer = csv.DictWriter(f, fieldnames=csv_columns)
    writer.writeheader()
    writer.writerows(csv_reader)