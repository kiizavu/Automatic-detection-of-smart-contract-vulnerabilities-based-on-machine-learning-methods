from genericpath import isdir
import os
import time

def getVersionPragma(filename):                     # param la path cua contract          
    file = open(filename, 'r')
    data = file.readlines()
    for line in data:                               # duyet tung dong trong contract do
        if 'pragma' in line:                        # neu dong do chua chu "pragma"
            temp = line.split()                     # chuyen dong do thanh list ['pragma', 'solidity', '^0.4.19;']
            if len(temp) == 3 and temp[2][0].isnumeric() == True:       # ['pragma', 'solidity', '0.4.19;']
                return temp[2][0:-1]
            elif len(temp) == 3 and temp[2][1].isnumeric() == True:       # ['pragma', 'solidity', '^0.4.19;']
                return temp[2][1:-1]
            elif len(temp) == 3 and temp[2][1].isnumeric() == False:    # ['pragma', 'solidity', '<=0.4.19;']
                return temp[2][2:-1]
            elif len(temp) > 3 and temp[2][1].isnumeric() == True:      # ['pragma', 'solidity', '>0.4.22', '<0.6.0]
                return temp[2][1:]
            elif len(temp) > 3 and temp[2][1].isnumeric() == False:     # ['pragma', 'solidity', '>=0.4.22', '<0.6.0]
                return temp[2][2:]
    return '0.5.0'

contract_chua_scan = 'pentest_smartcontract/0'
scan = 'pentest_smartcontract/scan'

if not os.path.isdir(scan):
    os.mkdir(scan)

contracts = os.listdir(contract_chua_scan)

for i in range(len(contracts)):
# for contract in contracts:
    if '.sol' in contracts[i] or '.SOL' in contracts[i]:
        contract_path = os.path.join(contract_chua_scan, contracts[i])
        out_file = os.path.join(scan, contracts[i] + '.txt')

        print('\n\n===============================================================')
        print(i, contracts[i])

        contract_version = getVersionPragma(contract_path)

        print(contract_version)
        
        start = time.time()
        change_version_cmd = 'solc-select use ' + contract_version
        os.system(change_version_cmd)

        scan_cmd = 'timeout 3m python3 conkas/conkas.py --solidity-file ' + contract_path + '>' + out_file
        os.system(scan_cmd)
        end = time.time()
        print("Time scan:", end - start)
